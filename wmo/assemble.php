<?
	include('../build/config.php');

	assemble_set('inst_hoo', array(
		array('uldum_hoo_6.png', 780-22, 908),
		array('uldum_hoo_3.png', 471-8, 1201),
		array('uldum_hoo_4.png', 0, 291+82+4),
		array('uldum_hoo_5.png', 46, 1245+59),
		array('uldum_hoo_2.png', 220, 0),

		array('uldum_hoo_1.png', 758, 1642),
		array('inst_hoo.png', 1645,910),
		array('Uldum_Interior_Pyramid.png', 1855, 566),
	));

	#assemble_set('inst_rfc', array(
	#	array('LavaDungeon.png', 0, 0),
	#));

	#assemble_set('inst_wc', array(
	#	array('wailingcaverns_instance.png', 0, 0),
	#));

	#assemble_set('inst_sm', array(
	#	array('Monestary_Cathedral.png', 563, 12),
	#	array('Monestary_Cemetery.png', 0, 622),
	#	array('Monestary_War.png', 1200, 0),
	#	array('Monestary_Library.png', 1200, 1233),
	#), 'white');

	#assemble_set('inst_bfd', array(
	#	array('Blackfathom_instance.png', 0, 0),
	#));

	#assemble_set('inst_stocks', array(
	#	array('StormwindJail.png', 0, 0),
	#));

	#assemble_set('inst_gnomer', array(
	#	array('KZ_Gnomeragon_Instance.png', 0, 0),
	#));

	#assemble_set('inst_rfk', array(
	#	array('RazorfenKraul_instance.png', 0, 0),
	#));

	#assemble_set('inst_rfd', array(
	#	array('RazorfenDowns_instance.png', 0, 0),
	#));

	#assemble_set('inst_mara', array(
	#	array('KL_Maraudon_instance01.png', 0, 0),
	#));

	#assemble_set('inst_ulda', array(
	#	array('KZ_Uldaman_A.png', 727, 359),
	#	array('KZ_Uldaman_B.png', 0, 0),
	#));

	#assemble_set('inst_dm', array(
	#	array('KL_Diremaul_Instance.png', 0, 0),
	#));

	#assemble_set('inst_strat', array(
	#	array('Stratholme.png', 0, 0),
	#));

	#assemble_set('raid_naxx', array(
	#	array('Stratholme_raid.png', 0, 0),
	#	array('FrostWyrm_Final01.png', 2200, 250),
	#));

	#assemble_set('raid_mc', array(
	#	array('Blackrock_lower_guild.png', 0, 0),
	#));

	#assemble_set('inst_brd', array(
	#	array('Blackrock_lower_instance.png', 0, 0),
	#));

	#assemble_set('inst_st', array(
	#	array('AZ_SunkenTemple_Instance.png', 300, 0),
	#	array('AZ_SunkenTemple_Instance_lower.png', 0, 400),
	#));

	#assemble_set('raid_ony', array(
	#	array('KL_OnyxiasLair_B.png', 0, 0),
	#));

	#assemble_set('raid_aq40', array(
	#	array('Ahn_Qiraj.png', 0, 0),
	#	array('Ahn_Qiraj__cthun.png', 100, 930),
	#));

	#assemble_set('inst_sp', array(
	#	array('Coilfang_Draenei.png', 0, 0),
	#));

	#assemble_set('inst_ub', array(
	#	array('Coilfang_Marsh.png', 0, 0),
	#));

	#assemble_set('inst_sv', array(
	#	array('Coilfang_Pumping.png', 0, 0),
	#));

	#assemble_set('raid_ssc', array(
	#	array('Coilfang_Raid.png', 0, 0),
	#));

	#assemble_set('inst_mech', 'TK_Factory.png');
	#assemble_set('inst_bot', 'TK_Atrium.png');
	#assemble_set('inst_arc', 'TK_Arcane.png');
	#assemble_set('raid_tk', 'TK_Raid.png');

	#assemble_set('inst_sh', 'Hellfire_Military.png');
	#assemble_set('inst_bf', 'hellfire_DemonWing.png');
	#assemble_set('raid_mag', 'Hellfire_raid.png');

	#assemble_set('raid_gruul', 'Gronnraid.png');

	#assemble_set('inst_mt', 'ethereal_wing.png');
	#assemble_set('inst_slabs', 'shadow_council_wing.png');
	#assemble_set('inst_seth', 'demon_wing.png');
	#assemble_set('inst_ac', 'Draenei_wing.png');

	#assemble_set('inst_brc', 'BlackrockV2.png');
	#assemble_set('raid_bwd', 'BlackwingV2.png');
	#assemble_set('inst_sc', 'Deepholm.png');
	#assemble_set('inst_gb', 'KZ_GrimBatol.png');

	#assemble_set('raid_bot', 'KZ_GrimBatol_raid.png');
	#assemble_set('inst_hor', 'Icecrown_Halls_of_reflection.png');
	#assemble_set('inst_fos', 'Icecrown_dungeon.png');

	#assemble_set('inst_up', array(array('Valgarde_80GW.png', 0, -260)));

	#assemble_set('inst_vh', 'DalaranPrison.png');
	#assemble_set('inst_gun', 'GunDrakInterior.png');

	#assemble_set('inst_vc', array(
	#	array('az_deadmines_a.png', 72, 0),
	#	array('az_deadmines_b.png', 0, 360),
	#	array('inst_vc.png', 700, 430),
	#));

	#assemble_set('inst_sfk', array(
	#	array('LD_ShadowFangInterior_1.png', 0, -100),
	#	array('LD_ShadowFangInterior_2a.png', 220, 160),
	#	array('LD_ShadowFangInterior_2b.png', 330, 70),
	#	array('LD_ShadowFangInterior_3.png', 430, 117+70),
	#	array('LD_ShadowFangInterior_4.png', 562, 80),
	#));

	#assemble_set('inst_hos', 'ulduar_dwarf77.png');
	#assemble_set('inst_hol', 'ulduar_irongiant80.png');

	#assemble_set('inst_lbrs', array(
	#	array('lbrs_upper.png', 0, 0),
	#	array('lbrs_lower.png', 830, 0),
	#));

	#assemble_set('inst_ubrs', array(
	#	array('ubrs_lower.png', 0, 0),
	#	array('ubrs_upper.png', 400, 27),
	#));

	#assemble_set('raid_bh', 'tb_baradinhold.png');

	#assemble_set('inst_scholo', array(
	#	array('Ruinedkeep_crypt_instance_top.png', 0, 0),
	#	array('Ruinedkeep_crypt_instance_bottom.png', 540, -30),
	#	array('Ruinedkeep_crypt_instance_basement.png', 540+720-33, 99),
	#));

	#assemble_set('raid_voa', 'wintergrasp_raid.png');
	#assemble_set('inst_nexus', 'nexus_70.png');

	#assemble_set('inst_cos', array(
	#	array('Stratholme_Past.png', 0, 0),
	#	array('inst_cos.png', 223, 1260-92),
	#));

	#assemble_set('inst_ramps', array(
	#	array('inst_ramps.png', 0, 0),
	#	array('hellfire_ramparts.png', 550, -1150),
	#), '#AD5942');

	#assemble_set('raid_sunwell', array(
	#	array('sunwell.png', 680, 190),
	#	array('raid_sunwell.png', 0, 0),
	#), '#001D29');

	#assemble_set('inst_mgt', array(
	#	array('inst_mgt.png', 0, 120),
	#	array('sunwell_5man.png', 450, -120),
	#), '#335254');

	#assemble_set('inst_dtk', array(
	#	array('inst_dtk.png', 0, 145),
	#	array('DrakTharon_72_Wing.png', 450, -150),
	#), '#000000');

	#assemble_set('inst_toc', array(
	#	array('coliseum_intact_floor.png', -230, 0),
	#));

	#assemble_set('raid_toc', array(
	#	array('coliseum_intact_floor.png', -230, 825),
	#	array('nd_argentcrusadecoliseum_instance.png', 120, 0),
	#));

	#assemble_set('raid_bt', array(
	#	array('blacktemple_sewer.png', -163,1779),
	#	array('raid_bt.png', 222,1207),
	#	array('blacktemple_floor_1.png', 1216,0),
	#	array('blacktemple_floor_2.png', 886,821),
	#	array('blacktemple_floor_3.png', 986-(98+107),1961+135),
	#	array('blacktemple_floor_3a.png', 1597-107,2003+135-121),
	#	array('blacktemple_floor_4.png', 2039+7,779+45),
	#	array('blacktemple_floor_5.png', 1935,1289),
	#));

	#assemble_set('raid_fl', array(
	#	array('raid_fl.png', 0, 128),
	#	array('firelands_sulfuronkeep.png', 1024,0),
	#),'#310000');

	#assemble_set('raid_bwl', array(
	#	array('blackrock_upper_guild_floor_1.png', 0, 182+34),
	#	array('blackrock_upper_guild_floor_2.png', 520, 182),
	#	array('blackrock_upper_guild_floor_3.png', 520+520-(135), 0),
	#));

	#assemble_set('raid_kara', array(
	#	array('kharazan_instance_floor1.png', 0, 0),
	#	array('kharazan_instance_floor2.png', 650, 112),
	#	array('kharazan_instance_floor3.png', 222, 740),
	#	array('kharazan_instance_floor3b.png', 222+160-73, 740+372+400),

	#	array('kharazan_instance_floor4_base.png', 908+195+80, 108),
	#	array('kharazan_instance_floor4.png', 1000+195+80, 0),

	#	array('kharazan_instance_floor5_base.png', 382+1000-196, 1080-(100+207)),
	#	array('kharazan_instance_floor5.png', 382+1000, 1080-207),

	#	array('kharazan_instance_floor6_base.png', 1580+148+430, 81+27),
	#	array('kharazan_instance_floor6.png', 1580+430, 27),

	#	array('kharazan_instance_floor7.png', 2080, 78+1000-125),
	#	array('kharazan_instance_floor8.png', 2420, 78+1018-125),
	#	array('kharazan_instance_floor9.png', 2080+134, 78+1160),
	#));

	#assemble_set('raid_icc', array(
	#	array('IceCrownRaid.png', -580, -95),
	#	array('IceCrownRaid_middle_section.png', 470, 0),
	#	array('IceCrownRaid_arthas_precipice.png', 226, 1130),
	#));

	#assemble_set('raid_ulduar', array(

	#	array('Ulduar_Raid_mimiron.png', 0, 0),
	#	array('Ulduar_Raid_main.png', 2500-(988), 0+1262-700),

	#	array('raid_ulduar_1.png', 2100+2506-(295+988), 2164+1262+175-700),
	#	array('raid_ulduar_2.png', 2500+2104-(148+988), 760+1262-(232+700)),

	#	array('Ulduar_Raid_lower.png', 1773, 1998),
	#));

	#assemble_set('inst_uk', array(
	#	array('inst_uk_lower.png', 0, 0),
	#	array('inst_uk_upper.png', 0, 1010),
	#	array('inst_uk.png', 840, 1000),
	#));

	#assemble_set('raid_ds', array(
	#	array('raid_ds_hagara.png', 256, 0),
	#	array('raid_ds_main.png', 0, 288),
	#	array('raid_ds_warmaster.png', 800, 0),
	#	array('raid_ds_spine.png', 1396+32, 42),
	#	array('raid_ds_deathwing.png', 800, 629),
	#));

	function assemble_set($name, $tiles, $bg_color='black'){

		if (!is_array($tiles)){
			$tiles = array(array($tiles, 0, 0));
		}

		global $flats, $built;

		echo "$name : ";

		# get canvas size
		$max_w = 0;
		$max_h = 0;
		foreach ($tiles as $tile){
			list($w, $h) = getimagesize("$flats/$tile[0]");
			$max_w = max($max_w, $tile[1]+$w);
			$max_h = max($max_h, $tile[2]+$h);
		}
		$w = ceil($max_w / 256) * 256;
		$h = ceil($max_h / 256) * 256;

		# create canvas
		$temp = "$flats/__{$name}.png";
		$cmd = "convert xc:{$bg_color} -geometry !{$w}x{$h} $temp";
		echo shell_exec($cmd);
		foreach ($tiles as $tile){
			$x = ($tile[1]>=0?'+':'').$tile[1];
			$y = ($tile[2]>=0?'+':'').$tile[2];

			$cmd = "composite $flats/$tile[0] -geometry {$x}{$y} $temp $temp";
			echo shell_exec($cmd);
		}

#echo "DONE COMP\n";
#exit;
		# cut out z0 pieces

		$w /= 256;
		$h /= 256;

		shell_exec("rm -rf $built/$name");
		mkdir("$built/$name");

		for ($x=0; $x<$w; $x++){
		for ($y=0; $y<$h; $y++){

			$xp = $x * 256;
			$yp = $y * 256;

			$out = "$built/$name/tile_z0_".sprintf('%02d_%02d', $x, $y).'.png';
			$cmd = "convert $temp -crop 256x256+$xp+$yp +repage $out";

			echo shell_exec($cmd);
			echo '.';
		}
		}

		echo "done!\n";
	}
