<?
	include('../build/config.php');

	#assemble_set('inst_rfc', array(
	#	array('LavaDungeon.png', 0, 0),
	#));

	#assemble_set('inst_wc', array(
	#	array('wailingcaverns_instance.png', 0, 0),
	#));

	#assemble_set('inst_sm', array(
	#	array('Monestary_Cathedral.png', 563, 12),
	#	array('Monestary_Cemetery.png', 0, 622),
	#	array('Monestary_War.png', 1200, 0),
	#	array('Monestary_Library.png', 1200, 1233),
	#), 'white');

	#assemble_set('inst_bfd', array(
	#	array('Blackfathom_instance.png', 0, 0),
	#));

	#assemble_set('inst_stocks', array(
	#	array('StormwindJail.png', 0, 0),
	#));

	#assemble_set('inst_gnomer', array(
	#	array('KZ_Gnomeragon_Instance.png', 0, 0),
	#));

	#assemble_set('inst_rfk', array(
	#	array('RazorfenKraul_instance.png', 0, 0),
	#));

	#assemble_set('inst_rfd', array(
	#	array('RazorfenDowns_instance.png', 0, 0),
	#));

	#assemble_set('inst_mara', array(
	#	array('KL_Maraudon_instance01.png', 0, 0),
	#));

	#assemble_set('inst_ulda', array(
	#	array('KZ_Uldaman_A.png', 727, 359),
	#	array('KZ_Uldaman_B.png', 0, 0),
	#));

	#assemble_set('inst_dm', array(
	#	array('KL_Diremaul_Instance.png', 0, 0),
	#));

	#assemble_set('inst_strat', array(
	#	array('Stratholme.png', 0, 0),
	#));

	#assemble_set('raid_naxx', array(
	#	array('Stratholme_raid.png', 0, 0),
	#	array('FrostWyrm_Final01.png', 2200, 250),
	#));

	#assemble_set('raid_mc', array(
	#	array('Blackrock_lower_guild.png', 0, 0),
	#));

	#assemble_set('inst_brd', array(
	#	array('Blackrock_lower_instance.png', 0, 0),
	#));

	#assemble_set('inst_st', array(
	#	array('AZ_SunkenTemple_Instance.png', 300, 0),
	#	array('AZ_SunkenTemple_Instance_lower.png', 0, 400),
	#));

	#assemble_set('raid_ony', array(
	#	array('KL_OnyxiasLair_B.png', 0, 0),
	#));

	#assemble_set('raid_aq40', array(
	#	array('Ahn_Qiraj.png', 0, 0),
	#	array('Ahn_Qiraj__cthun.png', 100, 930),
	#));

	#assemble_set('inst_sp', array(
	#	array('Coilfang_Draenei.png', 0, 0),
	#));

	#assemble_set('inst_ub', array(
	#	array('Coilfang_Marsh.png', 0, 0),
	#));

	#assemble_set('inst_sv', array(
	#	array('Coilfang_Pumping.png', 0, 0),
	#));

	#assemble_set('raid_ssc', array(
	#	array('Coilfang_Raid.png', 0, 0),
	#));

	#assemble_set('inst_mech', 'TK_Factory.png');
	#assemble_set('inst_bot', 'TK_Atrium.png');
	#assemble_set('inst_arc', 'TK_Arcane.png');
	#assemble_set('raid_tk', 'TK_Raid.png');

	#assemble_set('inst_sh', 'Hellfire_Military.png');
	#assemble_set('inst_bf', 'hellfire_DemonWing.png');
	#assemble_set('raid_mag', 'Hellfire_raid.png');

	#assemble_set('raid_gruul', 'Gronnraid.png');

	#assemble_set('inst_mt', 'ethereal_wing.png');
	#assemble_set('inst_slabs', 'shadow_council_wing.png');
	#assemble_set('inst_seth', 'demon_wing.png');
	#assemble_set('inst_ac', 'Draenei_wing.png');

	#assemble_set('inst_brc', 'BlackrockV2.png');
	#assemble_set('raid_bwd', 'BlackwingV2.png');
	#assemble_set('inst_sc', 'Deepholm.png');
	#assemble_set('inst_gb', 'KZ_GrimBatol.png');

	#assemble_set('raid_bot', 'KZ_GrimBatol_raid.png');
	#assemble_set('inst_hor', 'Icecrown_Halls_of_reflection.png');
	#assemble_set('inst_fos', 'Icecrown_dungeon.png');

	#assemble_set('inst_up', array(array('Valgarde_80GW.png', 0, -260)));

	#assemble_set('inst_vh', 'DalaranPrison.png');
	#assemble_set('inst_gun', 'GunDrakInterior.png');

	#assemble_set('inst_vc', array(
	#	array('az_deadmines_a.png', 72, 0),
	#	array('az_deadmines_b.png', 0, 360),
	#	array('inst_vc.png', 700, 430),
	#));

	#assemble_set('inst_sfk', array(
	#	array('LD_ShadowFangInterior_1.png', 0, -100),
	#	array('LD_ShadowFangInterior_2a.png', 220, 160),
	#	array('LD_ShadowFangInterior_2b.png', 330, 70),
	#	array('LD_ShadowFangInterior_3.png', 430, 117+70),
	#	array('LD_ShadowFangInterior_4.png', 562, 80),
	#));

	#assemble_set('inst_hos', 'ulduar_dwarf77.png');
	#assemble_set('inst_hol', 'ulduar_irongiant80.png');

	#assemble_set('inst_lbrs', array(
	#	array('lbrs_upper.png', 0, 0),
	#	array('lbrs_lower.png', 830, 0),
	#));

	#assemble_set('inst_ubrs', array(
	#	array('ubrs_lower.png', 0, 0),
	#	array('ubrs_upper.png', 400, 27),
	#));

	#assemble_set('raid_bh', 'tb_baradinhold.png');

	assemble_set('inst_scholo', array(
		array('Ruinedkeep_crypt_instance_top.png', 0, 0),
		array('Ruinedkeep_crypt_instance_bottom.png', 540, -30),
		array('Ruinedkeep_crypt_instance_basement.png', 540+720-33, 99),
	));

	function assemble_set($name, $tiles, $bg_color='black'){

		if (!is_array($tiles)){
			$tiles = array(array($tiles, 0, 0));
		}

		global $flats, $built;

		echo "$name : ";

		# get canvas size
		$max_w = 0;
		$max_h = 0;
		foreach ($tiles as $tile){
			list($w, $h) = getimagesize("$flats/$tile[0]");
			$max_w = max($max_w, $tile[1]+$w);
			$max_h = max($max_h, $tile[2]+$h);
		}
		$w = ceil($max_w / 256) * 256;
		$h = ceil($max_h / 256) * 256;

		# create canvas
		$temp = "$flats/temp.png";
		$cmd = "convert xc:{$bg_color} -geometry !{$w}x{$h} $temp";
		echo shell_exec($cmd);
		foreach ($tiles as $tile){
			$x = ($tile[1]>=0?'+':'').$tile[1];
			$y = ($tile[2]>=0?'+':'').$tile[2];

			$cmd = "composite $flats/$tile[0] -geometry {$x}{$y} $temp $temp";
			echo shell_exec($cmd);
		}

#return;
		# cut out z0 pieces

		$w /= 256;
		$h /= 256;

		shell_exec("rm -rf $built/$name");
		mkdir("$built/$name");

		for ($x=0; $x<$w; $x++){
		for ($y=0; $y<$h; $y++){

			$xp = $x * 256;
			$yp = $y * 256;

			$out = "$built/$name/tile_z0_".sprintf('%02d_%02d', $x, $y).'.png';
			$cmd = "convert $temp -crop 256x256+$xp+$yp +repage $out";

			echo shell_exec($cmd);
			echo '.';
		}
		}

		echo "done!\n";
	}
